name: Fetch M3U8 Links

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  update-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create data folder
        run: mkdir -p data

      - name: Fetch M3U8 for channels
        run: |
          declare -A channels
          channels=(
            ["mbc_variety"]="https://www.elahmad.com/tv/mobiletv/glarb.php?id=mbc_variety"
            ["mbc1"]="https://www.elahmad.com/tv/mobiletv/glarb.php?id=mbc1"
            ["mbc2"]="https://www.elahmad.com/tv/mobiletv/glarb.php?id=mbc2"
          )

          for name in "${!channels[@]}"; do
            URL="${channels[$name]}"
            PAGE=$(curl -s -A "Mozilla/5.0" -e "https://www.elahmad.com/" "$URL")
            LINK=$(echo "$PAGE" | grep -o 'https[^"]*\.m3u8' | head -1)
            if [ -n "$LINK" ]; then
              echo "{\"link\": \"$LINK\"}" > data/${name}.json
              echo "Updated $name -> $LINK"
            else
              echo "{\"link\": \"\"}" > data/${name}.json
              echo "No M3U8 found for $name"
            fi
          done

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          git add data/*.json
          git commit -m "Update M3U8 links" || exit 0
          git push
